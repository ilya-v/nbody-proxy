#!/bin/bash

cd "$(dirname "$0")"
printf "content-type: text/html\r\n\r\n"

SSH_OPT="-o Port=8023 \
    -o BatchMode=yes \
    -o NoHostAuthenticationForLocalhost=yes \
    -o StrictHostKeyChecking=no \
    -o UserKnownHostsFile=/dev/null"
SSH_DEST=paperspace@localhost

mkdir -p "/var/www/nbody"
chmod u=rwx,o=rx "/var/www/nbody"
pushd "/var/www/nbody" 2>&1 1>/dev/null

RUN_DIR="./nbody-run"

rsync -e "ssh $SSH_OPT" \
    -a \
    $SSH_DEST:"$RUN_DIR/" ./

[[ "$?" != "0" ]] &&
    echo "$(date): Cannot fetch remote directory $RUN_DIR." &&
    exit

chmod -R u+rwX,go+rX,go-w ./ 

find .  -maxdepth 1 -type d  |
grep -vE '\.$' | 
grep -v './_params' | 
sed 's!\./!!' |
xargs -i echo @1{}@2{}@3 |
sed -e 's!@1!<a href="/!' \
    -e 's!@2!">!' \
    -e 's!@3!</a><br>!' > results.html
#\<a href="/{}">{}\</a> > results.html

echo "$(date): results fetched"
